package paperka20.instruction.paperka20.quiz;

import android.content.Intent;
import android.os.Bundle;
import android.widget.GridView;
import android.widget.Toast;

import androidx.appcompat.app.AppCompatActivity;

import com.instruction.paperka20.R;

import java.util.ArrayList;
import java.util.List;

public class QuizMainActivity extends AppCompatActivity {
    
    private GridView categoryGridView;
    private CategoryAdapter categoryAdapter;
    private QuizDatabase database;
    private List<Category> categories;
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_quiz_main);
        
        // Используем стандартный ActionBar вместо Toolbar
        if (getSupportActionBar() != null) {
            getSupportActionBar().setTitle("Викторина по охране труда");
            getSupportActionBar().setDisplayHomeAsUpEnabled(true);
        }
        
        categoryGridView = findViewById(R.id.categoryGridView);
        if (categoryGridView == null) {
            // Если элемент не найден, завершаем Activity
            finish();
            return;
        }
        
        database = QuizDatabase.getDatabase(this);
        
        loadCategories();
    }
    
    private void loadCategories() {
        categories = database.categoryDao().getAllCategories();
        
        // Список актуальных категорий, которые должны быть в базе
        List<String> expectedCategories = new ArrayList<>();
        expectedCategories.add("Офис");
        expectedCategories.add("Правила по ОТ №53");
        expectedCategories.add("Несчастный случай");
        
        // Проверяем, нужно ли обновить категории
        boolean needsUpdate = false;
        if (categories.isEmpty()) {
            needsUpdate = true;
        } else {
            // Проверяем, есть ли лишние категории или отсутствуют нужные
            for (Category cat : categories) {
                if (!expectedCategories.contains(cat.getName())) {
                    needsUpdate = true;
                    break;
                }
            }
            // Проверяем, все ли нужные категории есть
            for (String expectedName : expectedCategories) {
                boolean found = false;
                for (Category cat : categories) {
                    if (cat.getName().equals(expectedName)) {
                        found = true;
                        break;
                    }
                }
                if (!found) {
                    needsUpdate = true;
                    break;
                }
            }
        }
        
        // Если нужно обновить, очищаем и пересоздаем категории
        if (needsUpdate) {
            database.categoryDao().deleteAllCategories();
            initializeCategories();
            categories = database.categoryDao().getAllCategories();
        }
        
        categoryAdapter = new CategoryAdapter(this, categories, new CategoryAdapter.OnCategoryClickListener() {
            @Override
            public void onCategoryClick(Category category) {
                startQuizGame(category);
            }
        });
        
        categoryGridView.setAdapter(categoryAdapter);
    }
    
    private void initializeCategories() {
        List<Category> initialCategories = new ArrayList<>();
        
        // Создаем категории по порядку
        initialCategories.add(new Category("Офис",
            "21 вопрос",
            android.R.drawable.ic_menu_view));
        
        initialCategories.add(new Category("Правила по ОТ №53",
            "Категория в разработке",
            android.R.drawable.ic_menu_view));

        initialCategories.add(new Category("Несчастный случай",
                "Категория в разработке",
                android.R.drawable.ic_menu_view));
        
        database.categoryDao().insertCategories(initialCategories);
        
        // Создаем начальные вопросы для каждой категории
        List<Category> insertedCategories = database.categoryDao().getAllCategories();
        for (Category category : insertedCategories) {
            initializeQuestionsForCategory(category.getId());
        }
    }
    
    private void initializeQuestionsForCategory(int categoryId) {
        // Создаем примерные вопросы для каждой категории
        List<Question> questions = new ArrayList<>();
        
        // Получаем категорию для определения типа вопросов
        Category category = database.categoryDao().getCategoryById(categoryId);
        if (category == null) return;
        
        String categoryName = category.getName();
        
        // Сектор вопросов для категории Офис
        if (categoryName.contains("Офис")) {
            questions.add(new Question(categoryId, 1, 
                "При использовании в работе офисного оборудования работающим необходимо:",
                "Иметь удостоверение о проверке знаний по промышленной безопасности",
                "Пользоваться исправными выключателями, розетками, штепсельными вилками и другой электроарматурой",
                "Иметь действующую 3-ю группу по электробезопасности",
                "Проходить внеплановый инструктаж каждый день",
                2, "Пользоваться исправными выключателями, розетками, штепсельными вилками и другой электроарматурой."));
            
            questions.add(new Question(categoryId, 1,
                "Работник имеет право отказаться от выполнения порученной работы с использованием офисного оборудования в случае…",
                "Отсутствия удостоверения по охране труда",
                "Не прохождения им соответствующего инструктажа, стажировки и проверки знаний по вопросам охраны труда",
                "Возникновения непосредственной опасности для жизни и здоровья его и окружающих до устранения этой опасности",
                "Необходимо заполнить таблицу в MS excel, а навыков нет",
                3, "Возникновения непосредственной опасности для жизни и здоровья его и окружающих до устранения этой опасности."));
            
            questions.add(new Question(categoryId, 1,
                "На каком расстоянии от края, обращенного к работающему, на поверхности рабочего стола, должна располагаться клавиатура?",
                "50-70 см от края",
                    "100-300 мм от края",
                    "80-100 см от края",
                    "Не имеет значения",
                2, "На расстоянии 100-300 мм от края."));
            
            questions.add(new Question(categoryId, 1,
                "Как часто необходимо делать перерывы при работе за компьютером?",
                "Каждый час на 5-10 минут",
                    "Каждые 2 часа на 15 минут",
                    "Каждые 30 минут на 5 минут",
                    "Перерывы не обязательны",
                1, "Рекомендуется делать перерывы каждый час работы за компьютером на 5-10 минут для отдыха глаз."));
            
            questions.add(new Question(categoryId, 1,
                "Что необходимо делать при обнаружении неисправности офисного оборудования?",
                "Продолжить работу",
                    "Самостоятельно починить",
                    "Немедленно отключить и сообщить руководителю",
                    "Использовать другое оборудование",
                3, "При обнаружении неисправности оборудование необходимо немедленно отключить его и сообщить руководителю."));
            
            questions.add(new Question(categoryId, 2,
                "На каком расстоянии от глаз располагается монитор?",
                "200 - 300 мм от глаз, но не ближе 150 мм",
                "100 - 200 мм от глаз, но не ближе 50 мм",
                "600 - 700 мм от глаз, но не ближе 500 мм",
                "1600 - 1700 мм от глаз, но не ближе 1500 мм",
                3, "На расстоянии 600 - 700 мм от глаз, но не ближе 500 мм."));
            
            questions.add(new Question(categoryId, 2,
                "Что допускается при выполнении работы с использованием офисного оборудования работающему?",
                "Прерывать работу за монитором на регламентированные перерывы, с целью сокращения рабочей нагрузки у экрана",
                    "Работать мокрыми руками и способствовать попаданию влаги на поверхность офисного оборудования",
                    "Качаться на стуле, если стул дорогой и вы большой начальник",
                    "Производить самостоятельно вскрытие и ремонт офисного оборудования",
                1, "Прерывать работу за монитором на регламентированные перерывы, с целью сокращения рабочей нагрузки у экрана."));
            
            questions.add(new Question(categoryId, 1,
                "Можно ли подключать к одной розетке несколько мощных электроприборов через удлинитель?",
                "Да, если удлинитель качественный",
                    "Нет, это может привести к перегрузке и пожару",
                    "Да, если приборы используются по очереди",
                    "Да, если розетка новая",
                2, "Подключение нескольких мощных приборов к одной розетке может привести к перегрузке сети и пожару."));
            
            questions.add(new Question(categoryId, 1,
                "Что делать при возгорании офисного оборудования?",
                "Попытаться потушить водой",
                    "Немедленно отключить от сети и использовать огнетушитель",
                    "Принять свою судьбу. Всё тлен",
                    "Вынести оборудование на улицу",
                2, "При возгорании электрооборудования его необходимо немедленно отключить от сети и использовать огнетушитель (не водой!)."));
            
            questions.add(new Question(categoryId, 2,
                "Какое освещение должно быть в офисном помещении?",
                "Только искусственное", "Только естественное", "Комбинированное (естественное + искусственное)", "Любое",
                3, "В офисных помещениях должно быть комбинированное освещение - естественное и искусственное."));
            
            questions.add(new Question(categoryId, 1,
                "Как правильно поднимать тяжелые предметы в офисе?",
                "Согнув спину",
                    "С прямой спиной, приседая",
                    "Резким движением",
                    "Позвать коллегу мужского пола",
                2, "Тяжелые предметы нужно поднимать с прямой спиной, приседая и используя мышцы ног."));
            
            questions.add(new Question(categoryId, 2,
                "Что необходимо сделать по окончании работы с использованием офисного оборудования?",
                "Накрыть всё офисное оборудование плотной драповой тканью",
                    "Отключить офисное оборудование от электрической сети",
                    "Встать из-за стола и громко, с хохотом, сообщить коллегам об окончании вашей работы",
                    "Удерживая кнопку выключения на системном блоке, завершить текущий сеанс работы, не закрывая активных задач",
                2, "Отключить офисное оборудование от электрической сети."));
            
            questions.add(new Question(categoryId, 1,
                "При повреждении офисного оборудования, проводов, кабелей, неисправности заземления, появлении запаха гари?",
                "Продолжить работу. Работа сама себя не сделает",
                    "Немедленно отключить офисное оборудование от электрической сети. Сообщить о случившемся непосредственному руководителю",
                    "Отключить офисное оборудование от электрической сети. Уйти домой",
                    "Покинуть помещение. Сообщить о случившемся непосредственному руководителю",
                2, "Немедленно отключить офисное оборудование от электрической сети. Сообщить о случившемся непосредственному руководителю."));
            
            questions.add(new Question(categoryId, 1,
                "Можно ли оставлять офисное оборудование включенным на ночь?",
                "Скорее да",
                    "Только компьютеры",
                    "Нет, кроме оборудования, которое должно работать круглосуточно",
                    "Да, если это ноутбук",
                3, "Офисное оборудование должно быть выключено на ночь, кроме того, которое должно работать круглосуточно (серверы и т.д.)."));
            
            questions.add(new Question(categoryId, 2,
                "Как правильно сидеть за рабочим столом?",
                "Полулежа",
                    "С прямой спиной, ноги на полу",
                    "Нога на ногу",
                    "На стуле без спинки",
                2, "За рабочим столом нужно сидеть с прямой спиной, ноги должны стоять стопами на полу."));
            
            questions.add(new Question(categoryId, 1,
                "Что делать при обнаружении запаха гари в офисе?",
                "Продолжить работу",
                    "Немедленно отключить все электроприборы и вызвать пожарных",
                    "Проветрить помещение",
                    "Игнорировать",
                2, "При обнаружении запаха гари необходимо немедленно отключить все электроприборы и вызвать пожарных."));
            
            questions.add(new Question(categoryId, 2,
                "Как часто необходимо проветривать офисное помещение?",
                "Раз в день",
                    "Каждый час на 5-10 минут",
                    "Не создавая скозняков",
                    "Только утром",
                2, "Офисные помещения необходимо проветривать регулярно, каждые 1-2 часа на 5-10 минут."));
            
            questions.add(new Question(categoryId, 1,
                "Можно ли использовать поврежденные провода и кабели?",
                "Да, если повреждение небольшое",
                    "Нет, это опасно",
                    "Да, если обмотать изолентой",
                    "Да, если не трогать поврежденное место",
                2, "Использование поврежденных проводов и кабелей запрещено, так как это может привести к поражению током или пожару."));
            
            questions.add(new Question(categoryId, 2,
                "Какая должна быть высота рабочего стола для комфортной работы?",
                "60-65 см",
                    "70-75 см",
                    "80-85 см",
                    "Не имеет значения",
                2, "Оптимальная высота рабочего стола составляет 70-75 см для большинства людей."));
            
            questions.add(new Question(categoryId, 1,
                "Что делать при поражении электрическим током коллеги?",
                "Схватить его за руку",
                    "Немедленно отключить источник электротока и вызвать скорую помощь",
                    "Дать воды",
                    "Перекрестить",
                2, "При поражении током необходимо немедленно отключить источник тока (не прикасаясь к пострадавшему!) и вызвать скорую помощь."));
            
            questions.add(new Question(categoryId, 2,
                "Как правильно организовать провода на рабочем месте?",
                "В кучу под столом",
                    "Аккуратно уложить и закрепить",
                    "Паучьей сетью",
                    "Связать в узел",
                2, "Провода должны быть аккуратно уложены и закреплены, чтобы не создавать опасности и не мешать работе."));

            //Вторая категория ПРАВИЛА №53!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        } else if (categoryName.contains("Правила по ОТ")) {
            questions.add(new Question(categoryId, 1,
                "Что такое «сильная жара»?",
                "Максимальная температура воздуха от +40 °C и выше",
                    "Максимальная температура воздуха от +20 °C и выше",
                    "Максимальная температура воздуха от +30 °C и выше",
                    "Максимальная температура воздуха от +25 °C и выше",
                3, "Максимальная температура воздуха от +30 °C и выше."));
            
            questions.add(new Question(categoryId, 1,
                "Что такое «сильный мороз»?",
                "Минимальная температура воздуха от -35 °C и ниже",
                    "Минимальная температура воздуха от -25 °C и ниже",
                    "Минимальная температура воздуха от -20 °C и ниже",
                    "Минимальная температура воздуха от -55 °C и ниже",
                2, "Минимальная температура воздуха от -25 °C и ниже."));



        //Третья категория ПРАВИЛА НС!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        } else if (categoryName.contains("Несчастный случай")) {
            questions.add(new Question(categoryId, 1,
                "Что такое «сильная жара»?",
                "Максимальная температура воздуха от +40 °C и выше",
                "Максимальная температура воздуха от +20 °C и выше",
                "Максимальная температура воздуха от +30 °C и выше",
                "Максимальная температура воздуха от +25 °C и выше",
                3, "Максимальная температура воздуха от +30 °C и выше."));

            questions.add(new Question(categoryId, 1,
                "Что такое «сильный мороз»?",
                "Минимальная температура воздуха от -35 °C и ниже",
                "Минимальная температура воздуха от -25 °C и ниже",
                "Минимальная температура воздуха от -20 °C и ниже",
                "Минимальная температура воздуха от -55 °C и ниже",
                2, "Минимальная температура воздуха от -25 °C и ниже."));
    }

        // Добавляем дополнительные вопросы для всех категорий
        // Для демонстрации добавляем базовые вопросы (минимум 21 вопрос на категорию)
        int existingQuestions = questions.size();
        int questionsNeeded = Math.max(0, 21 - existingQuestions);
        
        for (int i = 0; i < questionsNeeded; i++) {
            int level = 1; // Уровень сложности (не используется, но требуется для модели)
            questions.add(new Question(categoryId, level,
                "Вопрос по теме \"" + categoryName + "\", вопрос " + (i + 1),
                "Вариант 1", "Вариант 2", "Вариант 3", "Вариант 4",
                (i % 4) + 1, "Объяснение правильного ответа для вопроса по теме охраны труда."));
        }
        
        database.questionDao().insertQuestions(questions);
    }
    
    private void startQuizGame(Category category) {
        Intent intent = new Intent(this, QuizGameActivity.class);
        intent.putExtra("categoryId", category.getId());
        intent.putExtra("categoryName", category.getName());
        startActivity(intent);
    }
    
    @Override
    public boolean onSupportNavigateUp() {
        onBackPressed();
        return true;
    }
}

